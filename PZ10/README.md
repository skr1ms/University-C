# Практическая работа 10

## Задание

Создать текстовый файл с десятью строчками из любого текстового редактора вручную. В каждой строчке информация об одном предмете, например, название книги и количество страниц. В программе создать структуру, которая может хранить эту информацию. Создать массив структур и заполнить их информацией из текстового файла. Записать информацию из массива структур в другой текстовый файл.

Осуществить действия с файлом согласно индивидуальному заданию.

### 1. Файл с записями о книгах. Запись содержит название и количество страниц.

- Запретить чтение третьей записи. Вывести содержимое файла на консоль.
- Разрешить чтение третьей записи. Вывести содержимое файла на консоль.
- Посчитать количество доступных записей, вывести количество на консоль.

### 2. Файл с записями о читателях. Запись содержит ник и идентификатор.

- Запретить чтение с первой по пятую записи. Вывести содержимое файла на консоль.
- Разрешить чтение второй записи. Вывести содержимое файла на консоль.
- Посчитать количество доступных записей, вывести количество на консоль.

### 3. Файл с записями об учебных курсах. Запись содержит название и пояснение.

- Запретить чтение файла. Вывести содержимое файла на консоль.
- Разрешить чтение со второй по седьмую записи. Вывести содержимое файла на консоль.
- Посчитать количество доступных записей, вывести количество на консоль.

### 4. Файл с записями о студентах. Запись содержит имя и номер студенческого.

- Запретить чтение с седьмой записи до конца файла. Вывести содержимое файла на консоль.
- Разрешить чтение последней записи. Вывести содержимое файла на консоль.
- Посчитать количество доступных записей, вывести количество на консоль.

## Использование

### Компиляция и запуск

```bash
make        # Компилирует и запускает программу
make run    # Запускает программу
make clean  # Удаляет скомпилированные файлы и временные данные
```

### Структура файлов

- `file_locking.c` - программа для работы с блокировкой записей файла
- `books.txt` - текстовый файл с данными о книгах
- `books.bin` - бинарный файл, создаваемый программой (временный)

## Технические детали

Программа использует функции `fcntl()` для управления блокировками записей файла:
- `F_WRLCK` - блокировка записи на запись
- `F_UNLCK` - снятие блокировки
- `F_GETLK` - проверка статуса блокировки

## Ответы на вопросы

### 1. Как называется функция управления захватами записей?

Функция управления захватами записей называется **`fcntl()`** (file control). Эта функция позволяет устанавливать и проверять блокировки записей файла.

### 2. Почему содержимое файла, созданного вручную не совпадает с содержимым файла, заполненного из программы?

Содержимое файлов может не совпадать по следующим причинам:

- **Формат данных**: Программа записывает данные в бинарном формате (структуры Book), а текстовый редактор работает с текстовым форматом
- **Выравнивание структур**: Компилятор может добавлять padding (пустые байты) между полями структур для выравнивания в памяти
- **Кодировка**: Текстовые файлы используют кодировку символов, а бинарные файлы хранят данные в их внутреннем представлении
- **Размер записей**: Бинарные файлы хранят данные фиксированного размера (sizeof(Book)), а текстовые файлы имеют переменную длину строк

### 3. Какие входные параметры имеет функция управления захватами?

Функция `fcntl()` имеет следующие параметры:
```c
int fcntl(int fd, int cmd, struct flock *lock);
```

Параметры:
- **fd** - файловый дескриптор открытого файла
- **cmd** - команда управления блокировкой (F_SETLK, F_GETLK, F_SETLKW)
- **lock** - указатель на структуру `struct flock`, описывающую блокировку

### 4. Какие значения могут иметь параметры?

Параметр **cmd** может иметь следующие значения:
- `F_SETLK` - установить блокировку (неблокирующий режим)
- `F_SETLKW` - установить блокировку (блокирующий режим, ожидание освобождения)
- `F_GETLK` - проверить статус блокировки без установки

### 5. Какой тип данных имеет структура управления захватами?

Структура управления захватами имеет тип **`struct flock`** (file lock).

### 6. Какие поля имеет структура управления захватами?

Структура `struct flock` содержит следующие поля:
- **l_type** - тип блокировки (F_RDLCK, F_WRLCK, F_UNLCK)
- **l_whence** - точка отсчета для l_start (SEEK_SET, SEEK_CUR, SEEK_END)
- **l_start** - смещение от точки отсчета, где начинается блокировка
- **l_len** - длина блокируемого участка в байтах
- **l_pid** - ID процесса, владеющего блокировкой (заполняется при F_GETLK)

### 7. Какие значения могут иметь поля структуры?

Поле **l_type** может иметь значения:
- `F_RDLCK` - блокировка на чтение (read lock)
- `F_WRLCK` - блокировка на запись (write lock)
- `F_UNLCK` - снятие блокировки (unlock)

Поле **l_whence** может иметь значения:
- `SEEK_SET` - отсчет от начала файла
- `SEEK_CUR` - отсчет от текущей позиции
- `SEEK_END` - отсчет от конца файла

Поля **l_start** и **l_len** - целочисленные значения (off_t и off_t соответственно), задающие смещение и длину блокируемого участка в байтах.

